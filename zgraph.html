<html lang='ja'><head><meta charset="utf-8"><meta http-equiv="Content-Style-Type" content="text/css"><link rel="stylesheet" type="text/css" href="style.css" /><link rel="stylesheet" type="text/css" href="style_fukidashi.css" />
<script type="application/javascript" src="script.js"></script>
<meta name="description" content="">
<title>グラフを描く</title>
</head><body id="body">
<h1>グラフを描く</h1>
<div class="pp">
リアルタイムな測定データの更新と、リアルタイムなグラフの描画を実現する。
<span class="spanExplain">理解の流れ</span>
<ol>
<li><a href="https://qiita.com/chidakiyo/items/fe55071203a370ef6e61#appscript%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B">AppScriptを作成する</a>
<li><a href="https://www.aozora-blog.com/2018/09/01/post-644/">GAS(Google App Script)、どんなことができるの？使って勉強したことまとめ。</a>
<li><a href="https://qiita.com/inaling/items/23248b7290d8140f53fc">Google Apps Scriptでスクレイピングする方法</a>
<li><a href="https://qiita.com/chihiro/items/20a54865c15966e807ee">【GoogleAppsScript】スプレッドシート操作(セルへのデータ書き込み偏)</a>
<li><a href="https://developers.google.com/apps-script/reference/spreadsheet/range#setValues(Object)">Class Range</a>
<li><a href="https://www.sejuku.net/blog/22295#i-6">複数の配列要素を削除する方法</a>
<li><a href="https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Array/splice">Array.prototype.splice()</a>
<li><a href="https://tonari-it.com/gas-timed-driven-trigger/">【初心者向けGAS】時限式のイベントトリガーを設置して決まった時刻にBotを送信する方法</a>
</div>


<h2>手順</h2>
<div class="pp">
<h3>1.Googleアカウントを用意</h3>
<h3>2.Google Spread Sheetsでシートを作る</h3>
<h3>3.Apps Scriptを書く</h3>
<div class="pp">
[ツール]から、[スクリプトエディタ]を選択して、コードを入力。
<span class="spanExplain">Apps Script</span>
<pre>
function myFunction() {
  var sheet = SpreadsheetApp.openByUrl('スプレッドシートのURLのコピペ');
  var response = UrlFetchApp.fetch("http://raspberrypi.garameki.com/data/max31856_write.log");

  var contents = response.getContentText();
  var arr = contents.split('\n');
  arr = arr.splice(-1001,1000);
  
  for(var ii=0,len=arr.length;ii&lt;len;ii++)arr[ii] = arr[ii].split(',');
  
  sheet.getRange("A2:I1001").setValues(arr);
}
</pre>
</div>
<h3>4.Scriptを実行する</h3>
<h3>5.グラフを描く</h3>
<h3>6.グラフの右肩のマークをクリックしてグラフを公開し、iframeをホームページに埋め込む</h3>
<h3>7.sheetの編集からトリガーを選択</h3>
<div class="pp">
「トリガの追加」を押す<br>
<br>
モーダルウィンドウでの入力は下記の通り<br>
「実行するデプロイ」→「HEAD」<br>
「イベントソースを選択」→「時間主導型」<br>
「時間ベースのトリガーのタイプを選択」→「分ベースのタイマー」<br>
「時間の間隔を選択（分）」→「1分おき」<br>
</div>
<h3>以上</h3>
<br><br><br><br><br><br><br><br><br><br>
<h1>以降、没ネタ</h1>
Google Spread Sheetsに気をよくして、測定したデータを、自動でグラフ化して、それをホームページで閲覧できるようにしようと思います。<br>
ただし、CGIベースですので、グラフは、自動更新ではありません。
IFTTTでのアップデートは参考記事にこと描きませんが、グラフまで自動化した例は見当たりません。<br>
ここでは、Googleのドキュメントを踏襲して、Node.jsを使ったやり方で、できればグラフ化まで自動してみたいと思います。<br>
ピボットテーブルは自動でできるらしいことは、ドキュメントに書いてあります。自動グラフ化のドキュメントも捜してみます。<br>

<span class="spanExplain">参考サイト</span>
<ol>
<li><a href="https://developers.google.com/sheets/api/">Comprehensive access to spreadsheets</a>
<li><a href="https://developers.google.com/sheets/api/quickstart/python">Python Quickstart</a>
<li><a href="https://qiita.com/masaha03/items/fab8c8411a020ff2bd42">Google APIの認証の種類</a>
<li><a href="https://codezine.jp/article/detail/7977">途中から有料 : これだけ押さえておけばあらゆるAPIを呼び出せる！ Google APIを使用するための基本</a>
<li><a href="https://www.efusion.co.jp/whatsnew/google-maps-api-2018-aug/">Google Maps APIでの料金問題の最新まとめ</a>
<li><a href="https://qiita.com/chidakiyo/items/fe55071203a370ef6e61">Qiita : Google SpreadSheetが取得したデータを用いてグラフを作成する　（この部分は特にプログラミングは必要なく、普段使っているように表を元にグラフを作っておけば新しいデータを取得した際にグラフが更新される）</a>
<li><a href="https://www.kumilog.net/entry/2018/03/22/090000">PythonとSheets API v4でGoogleスプレッドシートを読み書きする</a>
<li><a href=""></a>
<li><a href=""></a>
</ol>
google APIのサービスの中には有料のものもあるので気を付ける
<span class="spanExplain">こんなサイトもみた</span>
<ul>
<li><a href="https://tecstaff.blog.so-net.ne.jp/2017-01-09_MESH">『MESH』と『IFTTT』で気温グラフ作りに挑戦　[★店員佐藤の写真日記]</a>
<li><a href="https://qiita.com/advent-calendar/2017/gcp">Google Cloud Platform Advent Calendar 2017</a>
<li><a href=""></a>
<li><a href=""></a>
<li><a href=""></a>
</ul>

<h2>導入</h2>
<div class="pp">
参考サイト２で導入はすべてOK
<h3>1.準備しておくもの</h3>
	<div class="pp">
	<ul>
	<li>python 2.6以上
	<li>pip パッケージインストーラ
	<li>googleのアカウント
	</ul>
	RaspberryPi3にはpython3とpipは備わっているので、googleアカウントを用意すればOK
	</div>
<h3>2.google spread sheets APIをオンにする</h3>
	<div class="pp">
	<br>
	<span style="border-radius:4px;background-color:skyblue;padding:5px;font-weight:bold;color:white;">ENABLE GOOGLE SHEETS API</span>を押す<br>
	<br>
	するとモーダルウィンドウが開いて、入力を求められる<br>
	Project名を入力して、許諾するにチェックを入れ、nextを押す<br>
	Client IDとClient Secretが発行されたら、<br>
	<br>
	<span style="border-radius:4px;background-color:skyblue;padding:5px;font-weight:bold;color:white;">DOWNLOAD CLIENT CONFIGURATION</span>を押す<br>
	<br>
	すると、どこに保存するか聞いてくるので、とりあえず、~/に保存。<br>
	「API Credentials and usage」はいつでも、「APIコンソール」から、変更できます。とのこと。<br>
	ダウンロードしたファイルは自分のワーキングディレクトリに入れてくださいとのこと。<br>
	たぶん、pythonコードを実行するディレクトリだと思うから、あとでcgi-binに移す。<br>
	</div>
<h3>3.ライブラリをダウンロード</h3>
	<div class="pp"></div>
	<pre>
$ <span class="spanCaution">pip install --upgrade google-api-python-client oauth2client</span>
Collecting google-api-python-client
  Downloading https://files.pythonhosted.org/packages/56/04/5259a17a16a779426f6e2ac62796135b0d4a59cf8033a21037fd4ba5bf81/google_api_python_client-1.7.4-py3-none-any.whl (55kB)
Collecting oauth2client
  Downloading https://files.pythonhosted.org/packages/95/a9/4f25a14d23f0786b64875b91784607c2277eff25d48f915e39ff0cff505a/oauth2client-4.1.3-py2.py3-none-any.whl (98kB)
Collecting google-auth&gt;=1.4.1 (from google-api-python-client)
  Downloading https://files.pythonhosted.org/packages/24/62/8b9612b1055cfbecd577e252446fe5f939f6818d0b7ddc27bb872f233cd4/google_auth-1.6.1-py2.py3-none-any.whl (68kB)
Collecting google-auth-httplib2&gt;=0.0.3 (from google-api-python-client)
  Downloading https://files.pythonhosted.org/packages/33/49/c814d6d438b823441552198f096fcd0377fd6c88714dbed34f1d3c8c4389/google_auth_httplib2-0.0.3-py2.py3-none-any.whl
Collecting six&lt;2dev,&gt;=1.6.1 (from google-api-python-client)
  Downloading https://files.pythonhosted.org/packages/67/4b/141a581104b1f6397bfa78ac9d43d8ad29a7ca43ea90a2d863fe3056e86a/six-1.11.0-py2.py3-none-any.whl
Collecting httplib2&lt;1dev,&gt;=0.9.2 (from google-api-python-client)
  Downloading https://files.pythonhosted.org/packages/ce/ed/803905d670b52fa0edfdd135337e545b4496c2ab3a222f1449b7256eb99f/httplib2-0.12.0.tar.gz (218kB)
Collecting uritemplate&lt;4dev,&gt;=3.0.0 (from google-api-python-client)
  Downloading https://files.pythonhosted.org/packages/e5/7d/9d5a640c4f8bf2c8b1afc015e9a9d8de32e13c9016dcc4b0ec03481fb396/uritemplate-3.0.0-py2.py3-none-any.whl
Collecting pyasn1-modules&gt;=0.0.5 (from oauth2client)
  Downloading https://files.pythonhosted.org/packages/19/02/fa63f7ba30a0d7b925ca29d034510fc1ffde53264b71b4155022ddf3ab5d/pyasn1_modules-0.2.2-py2.py3-none-any.whl (62kB)
Collecting pyasn1&gt;=0.1.7 (from oauth2client)
  Downloading https://files.pythonhosted.org/packages/d1/a1/7790cc85db38daa874f6a2e6308131b9953feb1367f2ae2d1123bb93a9f5/pyasn1-0.4.4-py2.py3-none-any.whl (72kB)
Collecting rsa&gt;=3.1.4 (from oauth2client)
  Downloading https://files.pythonhosted.org/packages/02/e5/38518af393f7c214357079ce67a317307936896e961e35450b70fad2a9cf/rsa-4.0-py2.py3-none-any.whl
Collecting cachetools&gt;=2.0.0 (from google-auth&gt;=1.4.1-&gt;google-api-python-client)
  Downloading https://files.pythonhosted.org/packages/76/7e/08cd3846bebeabb6b1cfc4af8aae649d90249b4aeed080bddb5297f1d73b/cachetools-3.0.0-py2.py3-none-any.whl
Installing collected packages: six, cachetools, pyasn1, rsa, pyasn1-modules, google-auth, httplib2, google-auth-httplib2, uritemplate, google-api-python-client, oauth2client
  Running setup.py install for httplib2: started
    Running setup.py install for httplib2: finished with status 'done'
Successfully installed cachetools-3.0.0 google-api-python-client-1.7.4 google-auth-1.6.1 google-auth-httplib2-0.0.3 httplib2-0.12.0 oauth2client-4.1.3 pyasn1-0.4.4 pyasn1-modules-0.2.2 rsa-4.0 six-1.11.0 uritemplate-3.0.0
You are using pip version 10.0.1, however version 18.1 is available.
You should consider upgrading via the 'python -m pip install --upgrade pip' command.
	</pre>
	</div>
<h3>4.pythonコードを実行</h3>
	<div class="pp">
	新規でquickstart.pyを~/に作成して、コードをコピペして実行する
	<pre>
$ <span class="spanCaution">python3 quickstart.py</span>
	</pre>
	<img src="graph_1.jpg"><br>
	危険なので気を付けましょうという表示が出たら、確認して<br>
	<br>
	<span style="border-radius:4px;background-color:skyblue;padding:5px;font-weight:bold;color:white;">許可</span>を押す<br>
	<br>
	「The authentication flow has completed.」と、表示されたら、認証終了。
	<br>
	</div>
</div>


<br><hr><div style="text-align:right;"><a href="http://raspberrypi.garameki.com#20181126">がらめきドットコム</a><br>Powered by RaspberryPi3B+ Raspbian stretch</div></body></html>
