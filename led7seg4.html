<html lang='ja'><head><meta charset="utf-8"><meta http-equiv="Content-Style-Type" content="text/css"><link rel="stylesheet" type="text/css" href="style.css" /><script type="application/javascript" src="script.js"></script>
<meta name="description" content="">
<title>７segLEDを点灯させる</title>
</head><body id="body">

<h1>7SEG LEDで4桁表示</h1>
<div class="pp">
<img src="led7seg4_1.jpg">
<span class="spanExplain">参考サイト</span>
<ul>
<li><a href=""https://pinout.xyz/pinout/i2c>I2C - Inter Integrated Circuit</a>
<li><a href="http://akizukidenshi.com/download/ds/holtek/ht16K33v110.pdf">秋月電子通商 : PDF : HT16K33</a>
<li><a href="http://akizukidenshi.com/download/OSL40562-IR.pdf">OSL40562-IR</a>
<li><a href="https://cdn.sparkfun.com/datasheets/Components/LED/Serial-7-Segment-Display-v31.pdf">4桁7segシリアルボード</a>
<li><a href="https://hack-le.com/45642910-2/">Raspberry Pi でI2Cを使った7セグメントLEDで現在時刻を表示</a>
<li><a href="https://www.amazon.co.jp/IPOTCH-Arduino%E7%94%A8-LED%E3%83%87%E3%82%A3%E3%82%B9%E3%83%97%E3%83%AC%E3%82%A4%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB-4%E6%A1%81-7%E3%82%BB%E3%82%B0%E3%83%A1%E3%83%B3%E3%83%88-I2C-HT16K33-0-56%E3%82%A4%E3%83%B3%E3%83%81/dp/B07CNVSJRC/ref=cm_cr_arp_d_product_top?ie=UTF8">Amazon : IPOTCH Arduino用　LEDディスプレイモジュール　4桁　7セグメント　I2C HT16K33　0.56インチ</a>
<li><a href="https://www.adafruit.com/product/878">ADAFRUIT : 0.56" 4-DIGIT 7-SEGMENT DISPLAY W/I2C BACKPACK - RED</a>
<li><a href="https://manpages.debian.org/testing/i2c-tools/i2cset.8.en.html">Debian MANPAGES I2CSET(8)</a>
<li><a href="http://raspberrypi.garameki.com/sockets/client-socket-9801.html">i2cset (8) - Linux Man Pages</a>
</ul>
このモジュール用のドキュメントは見つけられなかった。<br>
たぶんAdafruitのパクリだろうから、同じように使えるのだろう。<br>
チップのピンのドキュメントが秋月電子通商さんのサイトにあったので、拝借した。
</div>

<h2>接続</h2>
<div class="pp">
ピン対応表
<table>
<tr><th>モジュール</th><th>ラズパイ</th></tr>
<tr><td>＋</td><td>3v3 Power</td></tr>
<tr><td>ー</td><td>Ground</td></tr>
<tr><td>D</td><td>BCM2(Data)</td></tr>
<tr><td>C</td><td>BCM3(Clock)</td></tr>
</table>
SPI接続に比べて楽ちんだ。
</div>

<h2>I2C通信を許可する</h2>
<div class="pp">
<h3>方法その１ 手動設定</h3>
<div class="pp">
<pre>
$ sudo raspi-config
</pre>
で、I2C interfaceをenableにすればよい。
</div>
<h3>方法その２ ブート設定</h3>
<div class="pp">
<span class="spanExplain">/boot/config.txt</span>
<pre>
dtparam=i2c=on,spi=on,i2s=on
</pre>
などと追加する。<br>
詳しくは<br>
<pre>
/boot/overlays/README
</pre>
を参照すること。
</div>
<h3>/boot/overlays/READMEについて</h3>
<div class="pp">
dtoverlayというディレクティブと<br>
dtparamというディレクティブを使う<br>
</div>

</div>

<h2>I2Cデバイスを確認</h2>
<div class="pp">
<pre>
$ i2cdetect -l
<span class="spanCaution">i2c-1</span>	i2c       	bcm2835 I2C adapter             	I2C adapter
</pre>
<pre>
$ i2cdetect -y 1
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
     00:          -- -- -- -- -- -- -- -- -- -- -- -- -- 
     10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
     20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
     30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
     40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
     50: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
     60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
     70: 70 -- -- -- -- -- -- --                         
</pre>
0x70Hのアドレスが有効らしいことがわかった。<br>
<br>
<span class="spanExplain">チップの特性を知らないとこのコマンドは危険です</span>
<pre>
$ i2cdump -y 1 0x70
No size specified (using byte-data access)
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f    0123456789abcdef
00: 16 1d 4b 63 0d 2c 4a 14 35 aa 01 73 c3 80 06 a6    ??Kc?,J?5??s????
10: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
20: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
30: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
40: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
50: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
60: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
70: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
80: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
90: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
e0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00    ................
</pre>
初コンタクト<br>
<img src="led7seg4_2.jpg"><br>
勝手に点滅しだした。<br>

</div>

<h2>コマンド表</h2>
<div class="pp">
HT16K33
<table>
<tr><th rowspan="2">Name</th><th colspan="8">Command/Address</th><th rowspan="2">Option</th><th rowspan="2">Description</th><th rowspan="2">Default</th></tr>
<tr><th>D15</th><th>D14</th><th>D13</th><th>D12</th><th>D11</th><th>D10</th><th>D9</th><th>D8</th></tr>
<tr><th>Display<br>data<br>Address<br>pointer</th><td>0</td><td>0</td><td>0</td><td>0</td><td>A3</td><td>A2</td><td>A1</td><td>A0</td><td>{A0-A3}<br>R/W</td><td><ul><li>Five bits of immediate data,gits A0 to A3,are transferred to the data pointer to defineone of sixteen display RAM addresses.<li>If the Display data register address (An)is 0x00h〜0x0Fh,after reaching thememory location 0x0Fh,the pointer willreset to 0x00h.</td><td>00H</td></tr>
<tr><th>System<br>setup</th><td>0</td><td>0</td><td>1</td><td>0</td><td>X</td><td>X</td><td>X</td><td>S</td><td>{S}<br>Write only</td><td>Defines internal system oscillator on/off<ul><li>{0}:Turn off System oscillator (standby mode)<li>{1}:Turn on System oscillator (normal operation mode)</ul></td><td>20H</td></tr>
<tr><th>Key data<br>Address<br>pointer</th><td>0</td><td>1</td><td>0</td><td>0</td><td>0</td><td>K2</td><td>K1</td><td>K0</td><td>{K0〜K2}<br>Read only</td><td><ul><li>Three bits of immediate data, bits K0 to K2, are transffered to the data pointer to define one of six key data RAM addresses.<li>It is strongly recommended that the key data RAM of address 0x40H〜0x45H should be read continuously and in one operation, so the key data RAM of address should be started at 0x40H only.<li>If the Key data register address (An) is 0x40H〜0x45H,after reaching the memory location 0x45H, the pointer will reset to 0x40H.</ul></td><td>40H</td></tr>
<tr><th>Int flag<br>Address<br>pointer</th><td>0</td><td>1</td><td>1</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>Read only</td><td>Defines the INT flag address, Read INT flag status.<br>Interrupt flag signal output.When any key matrix key is pressed, after the completion of two key scan cycles, this int flag bit goes to a high level and remains at a high level until all key data has been read.</td><td>60H</td></tr>
<tr><th rowspan="2">Display<br>setup</th><td rowspan="2">1</td><td rowspan="2">0</td><td rowspan="2">0</td rowspan="2"><td rowspan="2">0</td><td rowspan="2">X</td><td rowspan="2">B1</td><td rowspan="2">B0</td><td rowspan="2">D</td><td>{D}<br>Write only</td><td>Defines Display on/off status.<ul><li>{0}:Display off<li>{1}:Display on</ul></td><td rowspan="2">80H</td></tr>
<tr><td>{B1,B0}<br>Write only</td><td>Defines the blinking frequency<ul><li>{0,0}=Blinking OFF<li>{0,1}=2Hz<li>{1,0}=1Hz<li>{1,1}=0.5Hz</ul></td></tr>
<tr><th>ROW/INT<br>set</th><td>1</td><td>0</td><td>1</td><td>0</td><td>X</td><td>X</td><td>act</td><td>row/int</td><td>{act,row/int}<br>Write only</td><td>Defines INT/ROW output pin select and INT pin output active level status.<ul>{X,0}:INT/ROW output pin is set to ROW driver output.<li>{0,1}:INT/ROW output pin is set to INT output,active low.<li>{1,1}:INT/ROW output pin is se  to INT output,active high.<ul></td><td>A0H</td></tr>
<tr><th>Dimming<br>set</th><td>1</td><td>1</td><td>1</td><td>0</td><td>P3</td><td>P2</td><td>P1</td><td>P0</td><td>{P3〜P0}<br>Write only</td><td>
Defines the pulse width of ROW.
<ul>
<li>{0,0,0,0}:1/16duty
<li>{0,0,0,1}:2/16duty
<li>{0,0,1,0}:3/16duty
<li>{0,0,1,1}:4/16duty
<li>{0,1,0,0}:5/16duty
<li>{0,1,0,1}:6/16duty
<li>{0,1,1,0}:7/16duty
<li>{0,1,1,1}:8/16duty
<li>{1,0,0,0}:9/16duty
<li>{1,0,0,1}:10/16duty
<li>{1,0,1,0}:11/16duty
<li>{1,0,1,1}:12/16duty
<li>{1,1,0,0}:13/16duty
<li>{1,1,0,1}:14/16duty
<li>{1,1,1,0}:15/16duty
<li>{1,1,1,1}:16/16duty
</ul>

</td><td>EFH</td></tr>
<tr><th>test<br>mode</th><td>1</td><td>1</td><td>0</td><td>1</td><td>1</td><td>0</td><td>0</td><td>1</td><td>Write only</td><td>HOLTEK use only</td><td>D9H</td></tr>
</table>
</div>

<h2>LEDを点ける</h2>
<div class="p">
<pre>
$ i2cset -y 1 0x70 0x21
$ i2cset -y 1 0x70 0x87
$ i2cset -y 1 0x70 0xE0
$ i2cset -y 1 0x70 0 0x06 0 0x6d 0 0 0 0x4f 0 0x5b i
</pre>
結果<br>
<img src="led7seg4_3.jpg"><br>
duty比を最低にして、点滅を0.5Hzにした。
</div>

<br><hr><div style="text-align:right;"><a href="http://raspberrypi.garameki.com#20181120">がらめきドットコム</a><br>Powered by RaspberryPi3B+ Raspbian stretch</div></body></html>
