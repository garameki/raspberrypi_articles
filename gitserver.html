<html lang='ja'><head><meta charset="utf-8"><meta http-equiv="Content-Style-Type" content="text/css"><link rel="stylesheet" type="text/css" href="style.css" /><link rel="stylesheet" type="text/css" href="style_fukidashi.css" />
<script type="application/javascript" src="script.js"></script>
<meta name="description" content="公開したくない情報のバージョン管理は、自サバですればいいことに気づいた。Gitサーバーを自分のラズパイに置けばOK">
<title>Gitサーバーを立てる|がらめきドットコム</title>
</head><body id="body">
<h1>Gitサーバーを立てる</h1>
WANには接続できるようにして、しかも、ドメインネームを伏せておけば、なんちゃってプライベートGitHubならぬGitPrivateHubの出来上がり。でも、データは、消える可能性があるということに留意。天下のGitHubでは、そういうことは起きない。
<span class="spanExplain">参考サイト</span><h2></h2>
<ul>
<li><a href="https://www.webprofessional.jp/setting-up-your-raspberry-pi-as-a-git-server/">たった1万円以下で作れる！Raspberry Piで動く自分だけのGitサーバー</a>
</ul>

<h2>手順</h2>
<div class="pp">
<span class="spanExplain">gitユーザー作成(piのままでもよい)</span>
<pre>
$ <span class="spanCaution">sudo adduser git</span>
ユーザ `git' を追加しています...
新しいグループ `git' (1001) を追加しています...
新しいユーザ `git' (1001) をグループ `git' として追加しています...
ホームディレクトリ `/home/git' を作成しています...
`/etc/skel' からファイルをコピーしています...
新しい UNIX パスワードを入力してください:<span class="spanCaution">git</span>
新しい UNIX パスワードを再入力してください:<span class="spanCaution">git</span>
passwd: パスワードは正しく更新されました
git のユーザ情報を変更中
新しい値を入力してください。標準設定値を使うならリターンを押してください
	フルネーム []: <span class="spanCaution">USAKU Takahashi</span>
	部屋番号 []: <span class="spanCaution">-</span>
	職場電話番号 []: <span class="spanCaution">-</span>
	自宅電話番号 []: <span class="spanCaution">-</span>
	その他 []: -</span>
以上で正しいですか? [Y/n] <span class="spanCaution">y</span>
</pre>
<span class="spanExplain">SSHのための鍵の生成</span>
<pre>
もう作ってあるから省略
</pre>
<span class="spanExplain">新しいリモートリポジトリの作成</span>
<pre>
$ <span class="spanCaution">cd /media/pi/SONY</span>
$ <span class="spanCaution">sudo mkdir --mode=755 git</span>
$ <span class="spanCaution">cd git</span>
$ <span class="spanCaution">sudo mkdir testRepo.git</span>
$ <span class="spanCaution">ls -l</span>
合計 4
drwxr-xr-x 2 root root 4096 11月 30 10:27 testRepo.git
$ <span class="spanCaution">cd testRepo.git</span>
$ <span class="spanCaution">sudo git init --bare</span>
Initialized empty Git repository in /media/pi/SONY/git/testRepo.git/
$ <span class="spanCaution">ls</span>
HEAD  branches  config  description  hooks  info  objects  refs
</pre>


<span class="spanExplain">ローカルリポジトリの作成</span>
<pre>
$ <span class="spanCaution">sudo git clone <span style="font-size:20px;">pi</span>@192.168.3.8<span style="font-weight:bold;">:</span>/media/pi/SONY/git/testRepo.git</span>
Cloning into 'testRepo'...
pi@192.168.3.8's password: <span class="spanCaution">****</span>
warning: You appear to have cloned an empty repository.
$ <span class="spanCaution">ls -l</span>
合計 40
drwxr-xr-x 3 root root 4096 11月 30 10:52 <span class="spanGreen">testRepo</span>
$ su git
パスワード:<span class="spanCaution">********</span>
git@raspberrypi:/home/pi/git $ <span class="spanCaution">cd /media</span>
git@raspberrypi:/media $ <span class="spanCaution">ls</span>
pi
git@raspberrypi:/media $ <span class="spanCaution">cd pi</span>
bash: cd: pi: <span class="spanGreen">許可がありません</span>
</pre>
なぜgit clone pi@〜なのか。先程作成したgitユーザーではマウントしてあるUSBメモリの[SONY]を参照できないからだった。<br>
gitリポジトリ専用のUSBメモリを/media/git/SONYとして、マウントしてあれば、git clone git@〜になる。<br>
ここまでで、ローカルリポジトリができた。<br>
<span class="spanExplain">ローカルネットワーク上の別のマシンからcloneしてみる</span>
<pre>
$ <span class="spanCaution">git clone pi@192.168.3.8:/media/pi/SONY/git/testRepo.git</span>
Cloning into 'testRepo'...
pi@192.168.3.8's password:<span class="spanCaution">*******</span>
warning: You appear to have cloned an empty repository.

$ <span class="spanCaution">ls -l</span>
drwxr-xr-x 1 usaku 197121 0 11月 30 11:22 <span class="spanGreen">testRopo</span>
</pre>

<span class="spanExplain">remoteの確認</span>
<pre>
$ cd /home/pi/git/testRepo
$ git remote -v
origin	pi@192.168.3.8:/media/pi/SONY/git/testRepo.git (fetch)
origin	pi@192.168.3.8:/media/pi/SONY/git/testRepo.git (push)
</pre>
originという名前で、リモートリポジトリが登録されている<br>

<span class="spanExplain">git pushしてみる</span>
<pre>
$ cd /home/pi/git
$ echo This is a test > tt.txt
bash: tt.txt: 許可がありません
$ cd ..
$ ls -l | grep testRepo
drwxr-xr-x 3 <span class="spanGreen">root root</span> 4096 11月 30 10:52 <span class="spanGreen">testRepo</span>
$ sudo chown pi:root testRepo
$ cd testRepo
$ echo This is a test > tt.txt
$ ls
tt.txt
$ git add tt.txt
fatal: Unable to create '/home/pi/git/testRepo/.git/index.lock': 許可がありません
$ sudo git add tt.txt
$ sudo git commit -m "first commit"

*** Please tell me who you are.

Run

  git config --global user.email "you@example.com"
  git config --global user.name "Your Name"

to set your account's default identity.
Omit --global to set the identity only in this repository.

fatal: unable to auto-detect email address (got 'root@raspberrypi.(none)')
$ sudo git config --global user.email "test@example.com"
$ sudo git config --global user.name "USAKU Takahashi"
$ sudo git commit -m "first commit"
[master (root-commit) f0da030] first commit
 1 file changed, 1 insertion(+)
 create mode 100644 tt.txt
$ sudo git push
pi@192.168.3.8's password: 
Counting objects: 3, done.
Writing objects: 100% (3/3), 226 bytes | 0 bytes/s, done.
Total 3 (delta 0), reused 0 (delta 0)

exit
^Z
[1]+  停止                  sudo git push
$ bg 1
[1]+ sudo git push &
$ ps
  PID TTY          TIME CMD
 9314 pts/3    00:00:00 bash
10171 pts/3    00:00:00 ps
$ ps -a
  PID TTY          TIME CMD
 7444 pts/0    00:00:25 python3
 7640 pts/1    01:03:30 python3
 9312 pts/2    00:00:07 vim
10143 pts/3    00:00:00 sudo
10147 pts/3    00:00:00 git
10148 pts/3    00:00:00 ssh
10175 pts/3    00:00:00 ps
$ fg 1
sudo git push

^C
$ vim /media/pi/SONY/git/testRepo/tt.txt
$ cat /media/pi/SONY/git/testRepo/tt.txt
cat: /media/pi/SONY/git/testRepo/tt.txt: そのようなファイルやディレクトリはありません
$ sudo git push --set-upstream origin master
pi@192.168.3.8's password: 
Counting objects: 3, done.
Writing objects: 100% (3/3), 226 bytes | 0 bytes/s, done.
Total 3 (delta 0), reused 0 (delta 0)

</pre>
#いつまで待っても終わらない...<br><br>
<span style="font-size:25px;color:gold;">これはUSBメモリにアクセスしようとしているのが良くない</span>
と思ったので、gitユーザーアカウントを取って、そこに、リモートリポジトリを格納し、バックアップはsuper user権限で、piユーザーからUSBメモリにrsyncしようと考えました。<br>
<br>



<span class="spanExplain">gitユーザーでやってみる</span>
<pre>
$ <span class="spanCaution">su git</span>
パスワード:<span class="spanCaution">********</span>
$ <span class="spanCaution">cd</span>
$ ssh-keygen -t rsa
Generating public/private rsa key pair.
Enter file in which to save the key (/home/git/.ssh/id_rsa): 
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /home/git/.ssh/id_rsa.
Your public key has been saved in /home/git/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:NNua943f/BigsrNqT7kOsYfOrsfslLvmNLvnw4kNrqs git@raspberrypi
The key's randomart image is:
+---[RSA 2048]----+
|                 |
|                 |
|        o        |
|       . +       |
|      . S . .    |
|      .= + . .   |
|     +O=B.o   .  |
|     =OBB= . o = |
|  E.+@%OB+  o.+ =|
+----[SHA256]-----+

$ ls
id_rsa  id_rsa.pub
$ chmod 400 id_rsa
$ chmod 444 id_rsa.pub
$ ls -l
合計 8
-r-------- 1 git git 1766 11月 30 13:33 id_rsa
-r--r--r-- 1 git git  397 11月 30 13:33 id_rsa.pub
$ cat id_rsa.pub >> authorized_keys
$ ls
authorized_keys  id_rsa  id_rsa.pub
$ su
パスワード:
root@raspberrypi:/home/git/.ssh# ls
authorized_keys  id_rsa  id_rsa.pub
root@raspberrypi:/home/git/.ssh# cat /home/pi/.ssh/id_rsa.pub >> authorized_keys
root@raspberrypi:/home/git/.ssh# cd /home/pi
root@raspberrypi:/home/pi# ls
MagPi	      ggg     oldconffiles  www		  デスクトップ	音楽
backup.sh     git     public	    ダウンロード  ドキュメント	画像
frontdown.sh  lcd.sh  python_games  テンプレート  ビデオ	公開
root@raspberrypi:/home/pi# cd /home/git/.ssh
root@raspberrypi:/home/git/.ssh# cat /home/pi/ggg >> authorized_keys
root@raspberrypi:/home/git/.ssh# cat authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC2Jm+8zlpIIFthGUm82b69tGkWl2CCpyL1O5oyXOtRBuMQNML8iecVZpzNzYus4bhnBoZmcKa4m6YTYLmXnePEtdrrz5U0xbeSnLCMuVvH1pl8obSpZFC9nUM8Xs6UDMqORtFFggvYlVsVRyz0RvcuPLjtQunMgemDMaYX/n+nx61cdG9hjFMbMcm2gKufo09FbKI53Qkrk/plylEWisfyLRXPvmESZchh2UDvbnjrQ6K9MrsjueqDwszGELQfv/gZleTRgwxj1J6B/sbBi8IabxeAX34+ZxHToTtEkjtqIcDARAlQVWvlZG61u+ujM17x4CY2KsNHAMaeImrKaWR7 git@raspberrypi
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDby+pOjkAI3fgLOBd47LnjiTgkkHGZOKiaV2616rA9IBqlij47we5/Py56WG3q2PrDYMZSAo8mgc+q5HJIMbvWuyEs+lS0ANQQiiIcNH4WzqO5qCvzvh+nJpeKWlj5XIl/1CTvKfsolpdl4IO9s1eThaAwDldMg9aLBrBaT7noQRMAmUrQ5pZr0c2rno4oAUcOCf6MfzjHWo37DbUWrj617VrC9mbnlEkNpeQxqwCPOnxMjYgZAxBQ0ViZF5NXLoKCnB11PsOh2b28H6+xiSGiJTxTOqjux6SI8VDJ2HfT6/lwSiG/GML7CdTigjPNjNZsqW6XXqeiq+lccfFs5Q6b pi@raspberrypi
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDIxU6a5NhvSlCCNeNxXY2c+6jS6iHY91dH7lNQxlgeTomes+E0XikBaVT4u95Njf2vuwp+Ds9oj28Ouxs4XMsG2wzcseHiYTtGW9+bvnBujMB0FQO4j89W3RWEhSFmbMhZC7tTa15jX6jqpuZv9o+uPGNdtLru4xgFQ+2684wsBJ4Myc+d0DU4SQ4ccHtvneDXTLYBwJ5PgTu1dLPGeHDMSnncL8QIb+Nn77g1XOrwWub6fCOjIebVAEYjd1DOUfHYY4CEPj5wkq+1twinO7rDLCLrV6H5Nik+2V8HMHxgqP0SnZs8snRBE1q6/rhoa3pEmdG7OTOBsXrLWzH2b6/H usaku@DESKTOP-4O5NGLG
root@raspberrypi:/home/git/.ssh# exit
exit
$ ls
authorized_keys  id_rsa  id_rsa.pub
$ cd ..
$ mkdir test2Repo.git
$ cd test2Repo.git
$ ls -l
合計 4
drwxr-xr-x 2 git git 4096 11月 30 13:39 test2Repo.git
$ cd test2Repo.git
$ git --bare --shared init
Unknown option: --shared
usage: git [--version] [--help] [-C <path>] [-c name=value]
           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]
           [-p | --paginate | --no-pager] [--no-replace-objects] [--bare]
           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]
           <command> [<args>]

$ git --bare init
Initialized empty Git repository in /home/git/test2Repo.git/
$ ls -l
合計 32
-rw-r--r-- 1 git git   23 11月 30 13:41 HEAD
drwxr-xr-x 2 git git 4096 11月 30 13:41 branches
-rw-r--r-- 1 git git   66 11月 30 13:41 config
-rw-r--r-- 1 git git   73 11月 30 13:41 description
drwxr-xr-x 2 git git 4096 11月 30 13:41 hooks
drwxr-xr-x 2 git git 4096 11月 30 13:41 info
drwxr-xr-x 4 git git 4096 11月 30 13:41 objects
drwxr-xr-x 4 git git 4096 11月 30 13:41 refs

$ exit
exit
pi@raspberrypi:~
$ cd
$ vim backup.sh
</pre>
次を挿入<br>
<span class="spanExplain">/home/pi/backup.sh</span>
<pre>
sudo mkdir -p $USBBACK/git
sudo rsync -av --delete /home/git $USBBACK/git
</pre>
gitユーザーのHOMEをまるまるUSBメモリに同期。
$USBBACKは/media/pi/TOSHIBA。



</div>



<h2></h2>
<div class="pp">
</div>


<h2></h2>
<div class="pp">
</div>


<h2></h2>
<div class="pp">
</div>



<br><hr><div style="text-align:right;"><a href="http://raspberrypi.garameki.com#">がらめきドットコム</a><br>Powered by RaspberryPi3B+ Raspbian stretch</div></body></html>
