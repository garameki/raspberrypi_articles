<html lang='ja'><head><meta charset="utf-8"><meta http-equiv="Content-Style-Type" content="text/css"><link rel="stylesheet" type="text/css" href="style.css" /><link rel="stylesheet" type="text/css" href="style_fukidashi.css" />
<script type="application/javascript" src="script.js"></script>
<meta name="description" content="データをgoogle spread sheetsにしまう">
<title>データログを取る|がらめきドットコム</title>
</head><body id="body">
<h1>データロギング</h1>
ログをGoogle Spread Sheetsに上げる、というとカッコがいい。<br>
でも、スタンドアロンには向かないとも思っている。<br>
でも、グラフとかを自分で好きに使えるのでうれしいかも。<br>
でも、そんなの苦手な人だっている。<br>
使える人は使えるが、使えない人は使えない。<br>
ITは使えない人のためにある。<br>
ITは様々な人の様々な環境をまっ平にすることができる。<br>
「ITは、ひとの上にひとを作らず、ひとの下にひとを作らず」<br>
そんなことを考えさせられたテーマだ。<br>
と、いうか、いつもそんなことを考えていない私ってことですね。<br>

<h2>max31856_write.pyにログ機能を追加</h2>
USBのフォーマットを変えたのでUSBに記録できるはず。<br>
<span class="spanExplain">max31856_write.py</span>
<pre>
# _*_ coding:utf-8 _*_

import sys
import codecs
from time import sleep
import spidev

from datetime import datetime

#関数
filename = "max31856.txt"	#権限は -rw-rw---- www-data www-data
filename_log = "/media/pi/TOSHIBA/backuptest4/max31856_write.log"
def fwrite(valueFlt,valueHJ,valueCJ):
	tempH = valueHJ * 0.0625
	tempC = valueCJ * 0.015625
	global filename
	file = codecs.open(filename,"w","utf-8")
	jsonResult = "{{FAULT:{0}\nHJ:{1}\nCJ:{2}\n}}".format(valueFlt,valueHJ,valueCJ)
	file.write(jsonResult)
	file.close()
	#ログ
	dateA = datetime.now()
	yy = dateA.strftime("%Y")
	mm = dateA.strftime("%m")
	dd = dateA.strftime("%d")
	hh = dateA.strftime("%H")
	MM = dateA.strftime("%M")
	ss = dateA.strftime("%S")
	form  = "{3},{4},{5},{6},{7},{8},{0},{1},{2}\n".format(tempH,tempC,valueFlt,yy,mm,dd,hh,MM,ss)
	file = codecs.open(filename_log,"a","utf-8")
	file.write(form)
	file.close()

dummy = 0

spi = spidev.SpiDev()
spi.open(0,0)			#/sys/bus/spi/devices/dev0.0を使う
spi.mode = 0x03			#モード3 CPOL:1 CPHA:1 ,Especially CPHA must be 1
spi.max_speed_hz = 1000000	#最大クロック周波数

args = sys.argv
if len(args)==2:
	if args[1] == "reset":
		#FAULTピンのリセット
		resp = spi.xfer2([0x80,0x17])
		sleep(1)

#通常計測
#xfer2はcsを下げたまま
#xferは1バイトごとにcsを下げ上げする
resp = spi.xfer2([0x80,0x55,0x35,0x00,0x3C,0xF6,0x57,0x80,0xFE,0xC0,0x00])	#設定と同時に計測するのでCR0の第6ビットを立てる
sleep(1)			#計測を待つ


#Faultの検知
resp = spi.xfer([0x0f,dummy])
if (resp[1] & 0xFF) != 0:
	valueFlt = resp[1]
	valueHJ = ""
	valueCJ = ""
	fwrite(valueFlt,"-","-")
	print("FAULT")
	print(resp)
else:

	valueFlt = resp[1]

	#熱電対の温度を読み込み
	resp = spi.xfer2([0x0C,0x0D,0x0E,dummy])
	valueHJ = resp[1] * 256 + resp[2]
	if (resp[1] & 0x80) != 0:
		valueHJ = -1 * (~(valueHJ - 1) & 0x7FFF)	#2の補数の10進数化

	#冷接点の温度を読み込み
	resp = spi.xfer2([0x0A,0x0B,dummy])
	valueCJ = (resp[1] << 6)  + (resp[2] >> 2)
	if (resp[1] & 0x80) != 0:
		valueCJ = -1 * (~(valueCJ - 1) & 0x7FFF)	#2の補数の10進数化

	fwrite(valueFlt,valueHJ,valueCJ)
spi.close()
</pre>
<h2>5分ごとにログを取る</h2>
<div class="pp">
<span class="spanExplain">cron -eで以下の行を追加</span>
<pre>
*/5 * * * * sudo python3 /home/pi/www/garameki/raspberrypi/cgi-bin/max31856_write.py
</pre>
</div>


<h1>以下、没ネタ</h1>
<span class="spanExplain">参考サイト</span>
<ul>
<li><a href="https://www.wikihow.tech/Create-a-Graph-Using-a-Spreadsheet">How to Create a Graph Using a Spreadsheet</a>
<li><a href="https://developers.google.com/sheets/api/quickstart/python">Google : SpreadSheets : Python Quickstart</a>
<li><a href="
">

</a>
<li><a href="
">

</a>
</ul>
<h2>Google Spread Sheets APIを使えるようにする</h2>
<div class="pp">
メニューは日本語なのに、ドキュメントが英語。<br>
Pythonが自動で選択されて、表示されてるんですけど、これって、普段の検索を追跡?<br>
<span class="spanExplain">クイックスタートに必要なもの</span>
<ol>
<li>Python2.6以上
<li>pipパッケージ
<li>グーグルアカウント
</ol>
<span style="padding:10px;border-radius:5px;background-color:#127097;color:white;font-size:15px;font-weight:bold;">ENABLE THE GOOGLE SHEETS API</span>をクリックする。<br>
</div>


<h2></h2>
<div class="pp">
</div>
<h2></h2>
<div class="pp">
</div>
<h2></h2>
<div class="pp">
</div>
<h2></h2>
<div class="pp">
</div>
<h2></h2>
<div class="pp">
</div>
<h2></h2>
<div class="pp">
</div>


	<body style="background-color:black;">
		<!–右からの吹き出し–>
		<div class="kaiwa"">
			<figure class="kaiwa-img-right">
				<img src="hyou_black.jpg" width="50px" alt="no-img2″>
				<figcaption class="kaiwa-img-description">
					USAKU
				</figcaption>
			</figure>
			<div class="kaiwa-text-left">
				<p class="kaiwa-text">
					HELLO
				</p>
			</div>
		</div>
		<!–左からの吹き出し–>
			<div class="kaiwa">
				<figure class="kaiwa-img-left">
					<img kind="icon" src="hyou_left_black.jpg" alt="no-img2″>
					<figcaption class="kaiwa-img-description">
						USAKU
					</figcaption>
				</figure>
				<div class="kaiwa-text-right">
					<p class="kaiwa-text">
						HELLO HERO
					</p>
				</div>
		</div>

<br><hr><div style="text-align:right;"><a href="http://raspberrypi.garameki.com#">がらめきドットコム</a><br>Powered by RaspberryPi3B+ Raspbian stretch</div></body></html>
